{{- if eq .chezmoi.os "windows" -}}
$ErrorActionPreference = "Stop"
Set-StrictMode -Version Latest

function Has-Starship { return [bool](Get-Command starship -ErrorAction SilentlyContinue) }
if (Has-Starship) { Write-Host "Starship already installed."; return }

# Try winget
if (Get-Command winget -ErrorAction SilentlyContinue) {
  try {
    Write-Host "Installing Starship via winget…"
    winget install --id Starship.Starship --silent --accept-package-agreements --accept-source-agreements --source winget
    if (Has-Starship) { Write-Host "Starship installed via winget."; return }
  } catch { Write-Warning "winget failed: $($_.Exception.Message)" }
}

# Try scoop
if (Get-Command scoop -ErrorAction SilentlyContinue) {
  try {
    Write-Host "Installing Starship via scoop…"
    scoop install starship
    if (Has-Starship) { Write-Host "Starship installed via scoop."; return }
  } catch { Write-Warning "scoop failed: $($_.Exception.Message)" }
}

# Fallback: official script to per-user dir (no admin)
$installDir = Join-Path $env:LOCALAPPDATA "Programs\starship\bin"
New-Item -ItemType Directory -Force -Path $installDir | Out-Null

$script = Invoke-WebRequest -UseBasicParsing -Uri "https://starship.rs/install.sh" | Select-Object -ExpandProperty Content
$scriptPath = Join-Path $env:TEMP "install_starship.sh"
Set-Content -Path $scriptPath -Value $script -Encoding Ascii

# Use WSL bash or Git Bash if available; else try PowerShell to run sh through MSYS if present.
$bash = (Get-Command bash -ErrorAction SilentlyContinue)?.Source
if ($bash) {
  & $bash -lc "sh '$scriptPath' -y -b '$installDir'"
} else {
  Write-Host "No bash found; attempting curl pipe via PowerShell…"
  $env:STARSHIP_INSTALL = $installDir
  Invoke-Expression "& { $(Invoke-WebRequest -UseBasicParsing https://starship.rs/install.ps1) }"
}

# Put fallback dir on PATH for this session (persist however you prefer later)
if (-not ($env:PATH -split ';' | Where-Object { $_ -eq $installDir })) {
  $env:PATH = "$installDir;$env:PATH"
}

if (Has-Starship) { Write-Host "Starship installed (fallback)."; }
else { throw "Starship installation failed." }
{{- end -}}
