{{- if eq .chezmoi.os "linux" -}}
#!/usr/bin/env bash
set -euo pipefail

#############
# Functions #
#############

has() { command -v "$1" >/dev/null 2>&1; }

# helper: append line to file only if exact line not present
ensure_line() {
  local line="$1" file="$2"
  grep -qxF "$line" "$file" 2>/dev/null || printf '%s\n' "$line" >> "$file"
}

##########
# Script #
##########

# Install Starship if missing
if ! has starship; then
  # Install to ~/.local/bin (works without sudo)
  mkdir -p "$HOME/.local/bin"
  curl -sS https://starship.rs/install.sh | sh -s -- -y -b "$HOME/.local/bin"
fi

# Idempotently ensure ~/.local/bin is on PATH and starship is initialized for bash
BASHRC="$HOME/.bashrc"

# Create file if missing
[ -f "$BASHRC" ] || touch "$BASHRC"

# Put ~/.local/bin on PATH for future bash shells (before starship init)
ensure_line 'export PATH="$HOME/.local/bin:$PATH"' "$BASHRC"

# Enable starship for bash (idempotent)
ensure_line 'eval "$(starship init bash)"' "$BASHRC"

# Sanity check
if ! has starship; then
  echo "ERROR: Starship installation failed." >&2
  exit 1
fi

echo "Starship installed and enabled for bash (idempotent). Open a new shell to see it."
{{- end -}}
