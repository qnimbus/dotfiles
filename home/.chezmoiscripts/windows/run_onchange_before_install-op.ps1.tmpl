{{ if and (eq .osid "windows") (not .ephemeral) (not .headless) -}}
# Install 1Password CLI using winget (idempotent)

# Configuration
$packageId = "AgileBits.1PasswordCLI"

Write-Host "Checking for 1Password CLI installation..." -ForegroundColor Blue

# Check if 1Password CLI is already installed
$opInstalled = $false
try {
    $opVersion = & op --version 2>$null
    if ($LASTEXITCODE -eq 0) {
        $opInstalled = $true
        Write-Host "1Password CLI is already installed (version: $opVersion)" -ForegroundColor Green
    }
} catch {
    # Command not found or failed
}

if (-not $opInstalled) {
    Write-Host "1Password CLI not found. Installing via winget..." -ForegroundColor Yellow
    
    # Check if winget is available
    try {
        $wingetVersion = & winget --version 2>$null
        if ($LASTEXITCODE -ne 0) {
            throw "winget not available"
        }
        Write-Host "Using winget version: $wingetVersion" -ForegroundColor Cyan
    } catch {
        Write-Error "winget is not available. Please install winget or the Microsoft Store version of App Installer."
        exit 1
    }
    
    # Install 1Password CLI
    try {
        Write-Host "Installing 1Password CLI..." -ForegroundColor Yellow
        & winget install --id $packageId --exact --silent --accept-source-agreements --accept-package-agreements
        
        if ($LASTEXITCODE -eq 0) {
            Write-Host "1Password CLI installed successfully!" -ForegroundColor Green
            
            # Verify installation
            try {
                $opVersion = & op --version 2>$null
                if ($LASTEXITCODE -eq 0) {
                    Write-Host "Installation verified. 1Password CLI version: $opVersion" -ForegroundColor Green
                } else {
                    Write-Warning "Installation completed but 'op' command not immediately available. You may need to restart your shell or add it to PATH manually."
                }
            } catch {
                Write-Warning "Installation completed but 'op' command not immediately available. You may need to restart your shell or add it to PATH manually."
            }
        } else {
            Write-Error "Failed to install 1Password CLI via winget (exit code: $LASTEXITCODE)"
            exit 1
        }
    } catch {
        Write-Error "Error installing 1Password CLI: $($_.Exception.Message)"
        exit 1
    }
} else {
    Write-Host "1Password CLI installation is up to date." -ForegroundColor Green
}

Write-Host "1Password CLI setup completed." -ForegroundColor Blue
{{- end -}}
